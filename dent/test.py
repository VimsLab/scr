# files = "[/media/jakep/eye/scr/pickle/train2/74L113_0.pkl, /media/jakep/eye/scr/pickle/train2/95R14_9.pkl][/media/jakep/eye/scr/pickle/train2/96L26_11.pkl, /media/jakep/eye/scr/pickle/train2/109L210_16.pkl][/media/jakep/eye/scr/pickle/train2/83L17_0.pkl, /media/jakep/eye/scr/pickle/train2/82L312_5.pkl][/media/jakep/eye/scr/pickle/train2/142R11_11.pkl, /media/jakep/eye/scr/pickle/train2/17R80_5.pkl][/media/jakep/eye/scr/pickle/train2/86L110_3.pkl, /media/jakep/eye/scr/pickle/train2/86L114_1.pkl][/media/jakep/eye/scr/pickle/train2/97R23_8.pkl, /media/jakep/eye/scr/pickle/train2/142L10_2.pkl][/media/jakep/eye/scr/pickle/train2/11R11_10.pkl, /media/jakep/eye/scr/pickle/train2/136R13_1.pkl][/media/jakep/eye/scr/pickle/train2/131R16_8.pkl, /media/jakep/eye/scr/pickle/train2/108R1113_0.pkl][/media/jakep/eye/scr/pickle/train2/6L43_8.pkl, /media/jakep/eye/scr/pickle/train2/10R31_0.pkl][/media/jakep/eye/scr/pickle/train2/140L1110_2.pkl, /media/jakep/eye/scr/pickle/train2/17L710_8.pkl][/media/jakep/eye/scr/pickle/train2/136L112_15.pkl, /media/jakep/eye/scr/pickle/train2/17R67_1.pkl][/media/jakep/eye/scr/pickle/train2/88R16_11.pkl, /media/jakep/eye/scr/pickle/train2/20R12_1.pkl][/media/jakep/eye/scr/pickle/train2/77L13_11.pkl, /media/jakep/eye/scr/pickle/train2/140L113_0.pkl][/media/jakep/eye/scr/pickle/train2/137R14_6.pkl, /media/jakep/eye/scr/pickle/train2/135R17_0.pkl][/media/jakep/eye/scr/pickle/train2/137L112_13.pkl, /media/jakep/eye/scr/pickle/train2/95R3210_5.pkl][/media/jakep/eye/scr/pickle/train2/14R11_9.pkl, /media/jakep/eye/scr/pickle/train2/94R14_2.pkl][/media/jakep/eye/scr/pickle/train2/20R40_8.pkl, /media/jakep/eye/scr/pickle/train2/14L112_0.pkl][/media/jakep/eye/scr/pickle/train2/17R31_10.pkl, /media/jakep/eye/scr/pickle/train2/10L19_1.pkl][/media/jakep/eye/scr/pickle/train2/136L110_4.pkl, /media/jakep/eye/scr/pickle/train2/87R113_14.pkl][/media/jakep/eye/scr/pickle/train2/84L324_8.pkl, /media/jakep/eye/scr/pickle/train2/6L45_3.pkl][/media/jakep/eye/scr/pickle/train2/17L313_11.pkl, /media/jakep/eye/scr/pickle/train2/17L39_13.pkl][/media/jakep/eye/scr/pickle/train2/97R27_13.pkl, /media/jakep/eye/scr/pickle/train2/91R123_2.pkl][/media/jakep/eye/scr/pickle/train2/10R112_10.pkl, /media/jakep/eye/scr/pickle/train2/11R20_2.pkl][/media/jakep/eye/scr/pickle/train2/107L19_9.pkl, /media/jakep/eye/scr/pickle/train2/133R14_3.pkl][/media/jakep/eye/scr/pickle/train2/135R18_11.pkl, /media/jakep/eye/scr/pickle/train2/135R10_9.pkl][/media/jakep/eye/scr/pickle/train2/88L112_8.pkl, /media/jakep/eye/scr/pickle/train2/79R10_1.pkl][/media/jakep/eye/scr/pickle/train2/95R218_13.pkl, /media/jakep/eye/scr/pickle/train2/145L120_4.pkl][/media/jakep/eye/scr/pickle/train2/14R310_7.pkl, /media/jakep/eye/scr/pickle/train2/121R2114_15.pkl][/media/jakep/eye/scr/pickle/train2/91R127_6.pkl, /media/jakep/eye/scr/pickle/train2/14L210_12.pkl][/media/jakep/eye/scr/pickle/train2/145R1210_4.pkl, /media/jakep/eye/scr/pickle/train2/133L11_10.pkl][/media/jakep/eye/scr/pickle/train2/83L37_4.pkl, /media/jakep/eye/scr/pickle/train2/77L213_13.pkl][/media/jakep/eye/scr/pickle/train2/154L18_10.pkl, /media/jakep/eye/scr/pickle/train2/19R38_2.pkl][/media/jakep/eye/scr/pickle/train2/91R129_8.pkl, /media/jakep/eye/scr/pickle/train2/154L12_1.pkl][/media/jakep/eye/scr/pickle/train2/86R211_5.pkl, /media/jakep/eye/scr/pickle/train2/95R12_12.pkl][/media/jakep/eye/scr/pickle/train2/10R21_13.pkl, /media/jakep/eye/scr/pickle/train2/90R21_1.pkl][/media/jakep/eye/scr/pickle/train2/10R18_7.pkl, /media/jakep/eye/scr/pickle/train2/20R33_2.pkl][/media/jakep/eye/scr/pickle/train2/91R39_4.pkl, /media/jakep/eye/scr/pickle/train2/94L26_9.pkl][/media/jakep/eye/scr/pickle/train2/140R113_6.pkl, /media/jakep/eye/scr/pickle/train2/95R241_1.pkl][/media/jakep/eye/scr/pickle/train2/90L110_5.pkl, /media/jakep/eye/scr/pickle/train2/10R37_11.pkl][/media/jakep/eye/scr/pickle/train2/145R127_11.pkl, /media/jakep/eye/scr/pickle/train2/96R114_2.pkl][/media/jakep/eye/scr/pickle/train2/15L1212_4.pkl, /media/jakep/eye/scr/pickle/train2/17L68_13.pkl][/media/jakep/eye/scr/pickle/train2/90L213_10.pkl, /media/jakep/eye/scr/pickle/train2/94R110_5.pkl][/media/jakep/eye/scr/pickle/train2/108L14_4.pkl, /media/jakep/eye/scr/pickle/train2/89L33_10.pkl][/media/jakep/eye/scr/pickle/train2/94L13_13.pkl, /media/jakep/eye/scr/pickle/train2/94L18_13.pkl][/media/jakep/eye/scr/pickle/train2/139L120_11.pkl, /media/jakep/eye/scr/pickle/train2/75R18_6.pkl][/media/jakep/eye/scr/pickle/train2/3R4111_0.pkl, /media/jakep/eye/scr/pickle/train2/20R17_6.pkl][/media/jakep/eye/scr/pickle/train2/108R1110_6.pkl, /media/jakep/eye/scr/pickle/train2/17R65_12.pkl][/media/jakep/eye/scr/pickle/train2/17L810_12.pkl, /media/jakep/eye/scr/pickle/train2/77L13_2.pkl][/media/jakep/eye/scr/pickle/train2/14L29_2.pkl, /media/jakep/eye/scr/pickle/train2/82L312_9.pkl][/media/jakep/eye/scr/pickle/train2/11L413_4.pkl, /media/jakep/eye/scr/pickle/train2/121L114_12.pkl][/media/jakep/eye/scr/pickle/train2/80R10_2.pkl, /media/jakep/eye/scr/pickle/train2/90L35_9.pkl][/media/jakep/eye/scr/pickle/train2/18L114_12.pkl, /media/jakep/eye/scr/pickle/train2/18L17_9.pkl][/media/jakep/eye/scr/pickle/train2/97R37_5.pkl, /media/jakep/eye/scr/pickle/train2/85R23_12.pkl][/media/jakep/eye/scr/pickle/train2/78L37_8.pkl, /media/jakep/eye/scr/pickle/train2/14L11_13.pkl][/media/jakep/eye/scr/pickle/train2/145R117_13.pkl, /media/jakep/eye/scr/pickle/train2/142L14_0.pkl][/media/jakep/eye/scr/pickle/train2/90L114_8.pkl, /media/jakep/eye/scr/pickle/train2/87L31_3.pkl][/media/jakep/eye/scr/pickle/train2/84L3212_13.pkl, /media/jakep/eye/scr/pickle/train2/121R227_8.pkl][/media/jakep/eye/scr/pickle/train2/135L11_4.pkl, /media/jakep/eye/scr/pickle/train2/11R36_13.pkl][/media/jakep/eye/scr/pickle/train2/83R25_4.pkl, /media/jakep/eye/scr/pickle/train2/83R29_3.pkl][/media/jakep/eye/scr/pickle/train2/80L27_13.pkl, /media/jakep/eye/scr/pickle/train2/6R48_5.pkl][/media/jakep/eye/scr/pickle/train2/140L1111_6.pkl, /media/jakep/eye/scr/pickle/train2/15R11_0.pkl][/media/jakep/eye/scr/pickle/train2/132L17_10.pkl, /media/jakep/eye/scr/pickle/train2/17L716_15.pkl][/media/jakep/eye/scr/pickle/train2/14R313_7.pkl, /media/jakep/eye/scr/pickle/train2/14R310_10.pkl][/media/jakep/eye/scr/pickle/train2/131R111_2.pkl, /media/jakep/eye/scr/pickle/train2/108R117_10.pkl]"
# bracket = files.split('[')[1:]
# bracket = [a[:-1] for a in bracket]
# a = []
# b = []
# for brack in bracket:
# 	one = brack.split(',')
# 	a.append(one[0])
# 	b.append(one[1])

# d = [(i,j) for i,j in zip(a,b)]
# print(len(d))



import torch
import torch.nn as nn
import torch.nn.functional as F 
from torchvision.models import resnet50, ResNet50_Weights


def printer(vals, names):
	print('\n')
	for val, name in zip(vals, names):
		print(f'{name}: {val.shape}')

class Encoder(nn.Module):
    def __init__(self, hidden_dim=256, nheads=8, num_encoder_layers=6, dropout_rate=0.1):
        super().__init__()
        backbone = resnet50(weights=ResNet50_Weights.DEFAULT)
        self.backbone = nn.Sequential(*list(backbone.children())[:-2])
        self.hidden_dim = hidden_dim
        self.nheads = nheads
        self.num_encoder_layers = num_encoder_layers
        self.dropout_rate = dropout_rate
        
        # Create a positional encoding module
        self.position_embedding = nn.Parameter(torch.randn(1, hidden_dim, 1, 1))
        
        # Create a linear layer for embedding the encoder features
        self.linear_emb = nn.Linear(2048, hidden_dim)
        
        # Create a transformer encoder
        encoder_layer = nn.TransformerEncoderLayer(d_model=hidden_dim, nhead=nheads, dropout=dropout_rate)
        self.encoder = nn.TransformerEncoder(encoder_layer, num_layers=num_encoder_layers)
        
    def forward(self, inputs):
        # Get the features from the backbone
        feature = self.backbone(inputs)
        
        # Flatten the features and apply the linear embedding
        batch_size, channels, height, width = feature.shape
        features = feature.flatten(2).transpose(1, 2) # shape: (batch_size, num_patches, channels)
        encoder_embedding = self.linear_emb(features) # shape: (batch_size, num_patches, hidden_dim)
        
        # Add the positional encoding to the embeddings
        position_encoding = self.position_embedding.repeat(batch_size, 1, height, width).flatten(2).transpose(1, 2)
        encoder_encoding = encoder_embedding + position_encoding # shape: (batch_size, num_patches, hidden_dim)
        
        # Apply the transformer encoder
        encoder_outputs = self.encoder(encoder_encoding.transpose(0, 1)) # shape: (seq_len, batch_size, hidden_dim)


        printer([inputs, feature, features, encoder_embedding, position_encoding, encoder_encoding, encoder_outputs], 
			['Input image', 'Backbone features', 'Flattened features', 'Linear embedding of features', 
			'Position Encoding', 'Encoder embedding', 'Encoder output'])
        
        return encoder_outputs



x = torch.rand((8, 3, 224, 256))
encoder = Encoder()
output = encoder(x)
